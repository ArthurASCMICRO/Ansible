---
- name: Installer VLC depuis partage via net use + Copy-Item + nettoyer
  hosts: all
  gather_facts: no

  vars:
    share_root: "\\\\nevs02\\s$"
    vlc_src: "\\\\nevs02\\s$\\ADMINAPP\\sources\\VLC\\vlc-3.0.23-win64.exe"
    vlc_local: "C:\\Temp\\vlc-3.0.23-win64.exe"
    share_user: "{{ vault_share_user }}"
    share_pass: "{{ vault_share_pass }}"

  tasks:
    - name: S'assurer que C:\Temp existe
      ansible.windows.win_file:
        path: C:\Temp
        state: directory

    - name: Monter le partage avec identifiants (net use)
      ansible.windows.win_shell: |
        net use "{{ share_root }}" /delete /y | Out-Null
        net use "{{ share_root }}" /user:"{{ share_user }}" "{{ share_pass }}" /persistent:no
      no_log: true
      changed_when: false

    - name: Copier VLC en local via Copy-Item
      ansible.windows.win_shell: |
        Copy-Item -Path "{{ vlc_src }}" -Destination "{{ vlc_local }}" -Force
        if (Test-Path "{{ vlc_local }}") { "OK: copied" } else { "KO: not copied" }
      register: copy_result
      changed_when: "'OK: copied' in copy_result.stdout"

    - name: Démonter le partage
      ansible.windows.win_shell: |
        net use "{{ share_root }}" /delete /y
      no_log: true
      changed_when: false
      failed_when: false

    - name: Installer VLC (silencieux)
      ansible.windows.win_package:
        path: "{{ vlc_local }}"
        arguments: "/S"
        state: present
      when: "'OK: copied' in copy_result.stdout"

    - name: Vérifier VLC
      ansible.windows.win_stat:
        path: "C:\\Program Files\\VideoLAN\\VLC\\vlc.exe"
      register: vlc_bin

    - name: Nettoyer l'installeur local si VLC installé
      ansible.windows.win_file:
        path: "{{ vlc_local }}"
        state: absent
      when: vlc_bin.stat.exists

    - name: DEBUG résultat final
      ansible.builtin.debug:
        msg:
          - "copy={{ copy_result.stdout | default('') }}"
          - "VLC installé={{ vlc_bin.stat.exists }}"
