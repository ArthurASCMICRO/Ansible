---
- name: Installer VLC depuis partage via net use + Copy-Item + nettoyer
  hosts: all
  gather_facts: no

  vars:
    share_root: "\\\\nevs02\\sources$"
    vlc_src: "\\\\nevs02\\sources$\\VLC\\vlc-3.0.23-win64.exe"
    vlc_local: "C:\\Temp\\vlc-3.0.23-win64.exe"
    share_user: "{{ vault_share_user }}"
    share_pass: "{{ vault_share_pass }}"

  tasks:
    - name: S'assurer que C:\Temp existe
      ansible.windows.win_file:
        path: C:\Temp
        state: directory

    - block:
        - name: Monter le partage avec identifiants (net use)
          ansible.windows.win_shell: |
            net use "{{ share_root }}" /delete /y | Out-Null
            net use "{{ share_root }}" /user:"{{ share_user }}" "{{ share_pass }}" /persistent:no
          no_log: true
          changed_when: false
        - name: Qui suis-je (contexte WinRM) ?
          ansible.windows.win_shell: whoami
          register: who
          changed_when: false
        
        - name: DEBUG whoami
          ansible.builtin.debug:
            var: who.stdout
        
        - name: DEBUG net use
          ansible.windows.win_shell: net use
          register: netuse
          changed_when: false
        
        - name: Afficher net use
          ansible.builtin.debug:
            var: netuse.stdout_lines





        - name: Tester l'accès au fichier VLC sur le partage
          ansible.windows.win_shell: |
            $p="{{ vlc_src }}"
            "Test-Path: " + (Test-Path $p)
            try { (Get-Item $p -ErrorAction Stop).FullName; "Get-Item OK" }
            catch { "Get-Item KO: " + $_.Exception.Message }
          register: share_test
          changed_when: false

        - name: DEBUG test accès fichier
          ansible.builtin.debug:
            var: share_test.stdout_lines

        - name: Copier VLC en local via Copy-Item
          ansible.windows.win_shell: |
            Copy-Item -Path "{{ vlc_src }}" -Destination "{{ vlc_local }}" -Force -ErrorAction Stop
          register: copy_result
          changed_when: true

        - name: Vérifier que l'installeur VLC est présent en local
          ansible.windows.win_stat:
            path: "{{ vlc_local }}"
          register: vlc_local_stat

        - name: Installer VLC (silencieux)
          ansible.windows.win_package:
            path: "{{ vlc_local }}"
            arguments: "/S"
            state: present
          when: vlc_local_stat.stat.exists

      always:
        - name: Démonter le partage (toujours)
          ansible.windows.win_shell: |
            net use "{{ share_root }}" /delete /y
          no_log: true
          changed_when: false
          failed_when: false

    - name: Vérifier VLC
      ansible.windows.win_stat:
        path: "C:\\Program Files\\VideoLAN\\VLC\\vlc.exe"
      register: vlc_bin

    - name: Nettoyer l'installeur local si VLC installé
      ansible.windows.win_file:
        path: "{{ vlc_local }}"
        state: absent
      when: vlc_bin.stat.exists

    - name: DEBUG résultat final
      ansible.builtin.debug:
        msg:
          - "VLC installé={{ vlc_bin.stat.exists }}"
