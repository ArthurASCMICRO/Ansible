---
- name: Diagnostic winget VLC (résumé)
  hosts: all
  gather_facts: no

  tasks:
    - name: Winget version
      ansible.windows.win_command: winget --version
      register: winget_version
      changed_when: false

    - name: Winget list VLC (table)
      ansible.windows.win_command: winget list --id VideoLAN.VLC --exact
      register: vlc_list
      changed_when: false
      failed_when: false

    - name: Winget list VLC (json)
      ansible.windows.win_command: winget list --id VideoLAN.VLC --exact --output json
      register: vlc_list_json
      changed_when: false
      failed_when: false

    - name: Winget show VLC (json)
      ansible.windows.win_command: winget show --id VideoLAN.VLC --exact --output json
      register: vlc_show_json
      changed_when: false
      failed_when: false

    - name: Résumé VLC (winget)
      ansible.builtin.debug:
        msg:
          - "winget={{ winget_version.stdout | default('') | trim }}"
          - "list_rc={{ vlc_list.rc }}"
          - "list_stdout_first_lines={{ (vlc_list.stdout | default('') ).splitlines()[0:6] }}"
          - "list_json_rc={{ vlc_list_json.rc }}"
          - "list_json_first_300={{ (vlc_list_json.stdout | default('') )[:300] }}"
          - "show_json_rc={{ vlc_show_json.rc }}"
          - "show_json_first_300={{ (vlc_show_json.stdout | default('') )[:300] }}"

    - name: Sources winget (json)
      ansible.windows.win_command: winget source list --output json
      register: winget_sources_json
      changed_when: false
      failed_when: false

    - name: Résumé sources (winget)
      ansible.builtin.debug:
        msg:
          - "sources_json_rc={{ winget_sources_json.rc }}"
          - "sources_json_first_300={{ (winget_sources_json.stdout | default('') )[:300] }}"

    - name: Vérifier si VLC existe via registre (64-bit)
      ansible.windows.win_shell: |
        $keys = @(
          'HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*',
          'HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'
        )
        $apps = foreach ($k in $keys) {
          Get-ItemProperty $k -ErrorAction SilentlyContinue |
            Where-Object { $_.DisplayName -match 'VLC media player' } |
            Select-Object DisplayName, DisplayVersion, Publisher, UninstallString
        }
        $apps | ConvertTo-Json -Compress
      register: vlc_reg
      changed_when: false
      failed_when: false

    - name: Résumé registre VLC
      ansible.builtin.debug:
        msg:
          - "vlc_reg_rc={{ vlc_reg.rc }}"
          - "vlc_reg_json={{ vlc_reg.stdout | default('') | trim }}"
