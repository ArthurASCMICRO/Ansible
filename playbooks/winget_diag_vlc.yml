---
- name: Fix winget sources + install VLC
  hosts: all
  gather_facts: no

  tasks:
    - name: Version winget
      ansible.windows.win_command: winget --version
      register: winget_version
      changed_when: false

    - name: winget source list
      ansible.windows.win_command: winget source list
      register: source_list_1
      changed_when: false
      failed_when: false

    - name: DEBUG sources (avant)
      ansible.builtin.debug:
        msg:
          - "{{ winget_version.stdout | default('') | trim }}"
          - "{{ source_list_1.stdout | default('') }}"

    - name: Reset des sources winget
      ansible.windows.win_command: winget source reset --force
      register: source_reset
      changed_when: false
      failed_when: false

    - name: Update des sources winget
      ansible.windows.win_command: winget source update
      register: source_update
      changed_when: false
      failed_when: false

    - name: winget source list (apres)
      ansible.windows.win_command: winget source list
      register: source_list_2
      changed_when: false
      failed_when: false

    - name: DEBUG sources (apres)
      ansible.builtin.debug:
        msg:
          - "reset_rc={{ source_reset.rc }}"
          - "update_rc={{ source_update.rc }}"
          - "{{ source_list_2.stdout | default('') }}"

    - name: Tester list VLC en forÃ§ant la source winget
      ansible.windows.win_command: winget list --id VideoLAN.VLC --exact --source winget
      register: vlc_list
      changed_when: false
      failed_when: false

    - name: DEBUG list VLC
      ansible.builtin.debug:
        msg:
          - "list_rc={{ vlc_list.rc }}"
          - "{{ vlc_list.stdout | default('') }}"
          - "{{ vlc_list.stderr | default('') }}"

    - name: Installer VLC (forcer source winget + logs)
      ansible.windows.win_command: >
        winget install --id VideoLAN.VLC --exact
        --source winget
        --silent
        --scope machine
        --accept-package-agreements
        --accept-source-agreements
        --disable-interactivity
        --verbose-logs
        --log C:\Temp\winget-vlc-install.log
      register: vlc_install
      changed_when: false
      failed_when: false

    - name: Lire log winget (tail)
      ansible.windows.win_shell: |
        if (Test-Path "C:\Temp\winget-vlc-install.log") {
          Get-Content "C:\Temp\winget-vlc-install.log" -Tail 200
        } else {
          "Log absent"
        }
      register: vlc_log
      changed_when: false
      failed_when: false

    - name: DEBUG install rc + log
      ansible.builtin.debug:
        msg:
          - "install_rc={{ vlc_install.rc }}"
          - "{{ (vlc_install.stdout | default(''))[-800:] }}"
          - "{{ vlc_log.stdout | default('') }}"
