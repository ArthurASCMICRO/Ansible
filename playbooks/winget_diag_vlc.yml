---
- name: Diagnostic winget VLC
  hosts: all
  gather_facts: no

  tasks:
    - name: Vérifier la présence de winget (version)
      ansible.windows.win_command: winget --version
      register: winget_version
      changed_when: false
      failed_when: winget_version.rc != 0

    - name: DEBUG winget --version
      ansible.builtin.debug:
        msg:
          - "winget rc={{ winget_version.rc }}"
          - "{{ winget_version.stdout | default('') }}"
          - "{{ winget_version.stderr | default('') }}"

    - name: Winget list VLC (id exact)
      ansible.windows.win_command: winget list --id VideoLAN.VLC --exact
      register: vlc_list
      changed_when: false
      failed_when: false

    - name: DEBUG winget list VLC
      ansible.builtin.debug:
        msg:
          - "winget list rc={{ vlc_list.rc }}"
          - "{{ vlc_list.stdout | default('') }}"
          - "{{ vlc_list.stderr | default('') }}"

    - name: Winget show VLC (infos package)
      ansible.windows.win_command: winget show --id VideoLAN.VLC --exact
      register: vlc_show
      changed_when: false
      failed_when: false

    - name: DEBUG winget show VLC
      ansible.builtin.debug:
        msg:
          - "winget show rc={{ vlc_show.rc }}"
          - "{{ vlc_show.stdout | default('') }}"
          - "{{ vlc_show.stderr | default('') }}"

    - name: Winget sources (pour voir si msstore/winget sont OK)
      ansible.windows.win_command: winget source list
      register: winget_sources
      changed_when: false
      failed_when: false

    - name: DEBUG winget source list
      ansible.builtin.debug:
        msg:
          - "winget source list rc={{ winget_sources.rc }}"
          - "{{ winget_sources.stdout | default('') }}"
          - "{{ winget_sources.stderr | default('') }}"

    - name: Tenter install VLC avec logs (sans faire échouer le job)
      ansible.windows.win_command: >
        winget install --id VideoLAN.VLC --exact
        --silent
        --scope machine
        --accept-package-agreements
        --accept-source-agreements
        --disable-interactivity
        --verbose-logs
        --log C:\Temp\winget-vlc-install.log
      register: vlc_install
      changed_when: false
      failed_when: false

    - name: DEBUG tentative install VLC
      ansible.builtin.debug:
        msg:
          - "winget install rc={{ vlc_install.rc }}"
          - "{{ vlc_install.stdout | default('') }}"
          - "{{ vlc_install.stderr | default('') }}"

    - name: Lire le log winget (tail 200)
      ansible.windows.win_shell: |
        if (Test-Path "C:\Temp\winget-vlc-install.log") {
          Get-Content "C:\Temp\winget-vlc-install.log" -Tail 200
        } else {
          "Log absent: C:\Temp\winget-vlc-install.log"
        }
      register: vlc_log
      changed_when: false
      failed_when: false

    - name: DEBUG log winget (tail)
      ansible.builtin.debug:
        var: vlc_log.stdout
